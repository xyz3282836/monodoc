---
title: "gc"
date: 2025-01-13 16:14:00 +8
category: go
tag:
  - go
  - gc
---

### èƒŒæ™¯

gcçš„å‡ ä¸ªé‡è¦é˜¶æ®µ

1. sweep termination æ¸…ç†ç»ˆæ­¢ï¼šæ¸…ç†ç»ˆæ­¢ï¼Œä¼šè§¦å‘stwï¼Œæ‰€æœ‰Péƒ½ä¼šè¿›å…¥sage-point å®‰å…¨ç‚¹ï¼Œå‡†å¤‡æ–°ä¸€è½®çš„gcï¼›

   **è§¦å‘ STWï¼ˆStop-the-Worldï¼‰**ï¼Œè®©æ‰€æœ‰çš„ **Pï¼ˆProcessorï¼‰** åœæ­¢ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œå¹¶è¿›å…¥ **safe-pointï¼ˆå®‰å…¨ç‚¹ï¼‰**ã€‚

   ğŸ”§ **å…³é”®ç‚¹ï¼š**
   - **safe-point** æ˜¯ GC å¯ä»¥å®‰å…¨æ‰§è¡Œçš„åœ°æ–¹ï¼Œé˜²æ­¢ç”¨æˆ·ä»£ç ä¿®æ”¹å†…å­˜ç»“æ„ã€‚

   - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒGo runtime ä¼šï¼š
     - **åœæ­¢ç”¨æˆ·ä»£ç **ï¼›
     - ç¡®ä¿ä¹‹å‰çš„æ¸…ç†é˜¶æ®µå®Œæˆï¼›
     - å‡†å¤‡å¼€å§‹**æ–°çš„æ ‡è®°é˜¶æ®µ**ã€‚

2. the mark phase æ ‡è®°é˜¶æ®µï¼šç¨‹åºå’ŒgcåŒæ—¶è¿è¡Œï¼Œgcæ‰§è¡Œæ ¹èŠ‚ç‚¹çš„æ ‡è®°ï¼Œè¿™åŒ…æ‹¬æ‰«ææ‰€æœ‰çš„æ ˆï¼Œå…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼›

   **å¹¶å‘æ‰§è¡Œ**ï¼ŒGC å’Œç”¨æˆ·ä»£ç åŒæ—¶è¿è¡Œã€‚

   ğŸ”§ **å…³é”®ç‚¹ï¼š**
   - ä»æ ¹å¯¹è±¡ï¼ˆroot setï¼‰å¼€å§‹ï¼Œæ ‡è®°æ‰€æœ‰**å¯è¾¾å¯¹è±¡**ã€‚

   - æ ¹å¯¹è±¡åŒ…æ‹¬ï¼š
     - **æ ˆå˜é‡**ï¼›
     - **å…¨å±€å˜é‡**ï¼›
     - **è¿è¡Œæ—¶æ•°æ®ç»“æ„**ã€‚

   - ä½¿ç”¨ **å†™å±éšœï¼ˆWrite Barrierï¼‰** ç¡®ä¿åœ¨æ ‡è®°é˜¶æ®µäº§ç”Ÿçš„æ–°å¯¹è±¡ä¹Ÿèƒ½è¢«æ­£ç¡®æ ‡è®°ã€‚

   ğŸ’¡ **å†™å±éšœçš„ä½œç”¨**ï¼š
   - é˜²æ­¢åœ¨æ ‡è®°é˜¶æ®µï¼Œç”¨æˆ·ä»£ç åˆ†é…æ–°å¯¹è±¡æ—¶ï¼Œè¿™äº›å¯¹è±¡è¢«é—æ¼ã€‚
   - ç¡®ä¿å¹¶å‘æ ‡è®°çš„å‡†ç¡®æ€§ã€‚

3. mark termination æ ‡è®°ç»ˆæ­¢ï¼šæ ‡è®°ç»ˆæ­¢ï¼Œè§¦å‘stwï¼Œç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½å·²æ ‡è®°å®Œæˆï¼ŒgcçŠ¶æ€å˜æ›´ï¼Œå…³é—­gcå·¥ä½œçº¿ç¨‹ï¼›

   **è§¦å‘ STW**ï¼Œæš‚åœæ‰€æœ‰ç”¨æˆ·ä»£ç ï¼Œç¡®ä¿æ ‡è®°è¿‡ç¨‹å®Œæˆã€‚

   ğŸ”§ **å…³é”®ç‚¹ï¼š**
   - è¿›å…¥ STW çŠ¶æ€ï¼Œåœæ­¢ç”¨æˆ·ä»£ç ã€‚

   - æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š
     - ç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½å·²è¢«æ­£ç¡®æ ‡è®°ã€‚
     - **å…³é—­æ ‡è®°çº¿ç¨‹**ã€‚
     - å‡†å¤‡è¿›å…¥æ¸…ç†é˜¶æ®µã€‚

4. sweep phase æ¸…ç†é˜¶æ®µï¼šæ¢å¤ç¨‹åºæ‰§è¡Œï¼Œåå°å¹¶å‘æ¸…ç†æ‰€æœ‰å†…å­˜ç®¡ç†å•å…ƒï¼›

   **å¹¶å‘æ‰§è¡Œ**ï¼Œå›æ”¶æœªæ ‡è®°çš„å†…å­˜å—ã€‚

   ğŸ”§ **å…³é”®ç‚¹ï¼š**
   - æ¢å¤ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œæ¸…ç†é˜¶æ®µ**åœ¨åå°å¹¶å‘è¿›è¡Œ**ã€‚

   - å›æ”¶æ‰€æœ‰**æœªæ ‡è®°çš„å¯¹è±¡**ï¼Œå°†å®ƒä»¬çš„å†…å­˜å—æ”¾å…¥**ç©ºé—²åˆ—è¡¨**ï¼Œä¾›åç»­åˆ†é…ä½¿ç”¨ã€‚

   - æ¸…ç†é˜¶æ®µæ˜¯**å¢é‡å®Œæˆ**çš„ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸…ç†é€ æˆé•¿æ—¶é—´æš‚åœã€‚

### è§¦å‘gc

åœ¨ Go ä¸­ä¸»è¦ä¼šåœ¨ä¸‰ä¸ªåœ°æ–¹è§¦å‘ GCï¼š

1ã€ç›‘æ§çº¿ç¨‹ runtime.sysmon å®šæ—¶è°ƒç”¨ï¼›

2ã€æ‰‹åŠ¨è°ƒç”¨ runtime.GC å‡½æ•°è¿›è¡Œåƒåœ¾æ”¶é›†ï¼›

3ã€ç”³è¯·å†…å­˜æ—¶ runtime.mallocgc ä¼šæ ¹æ®å †å¤§å°åˆ¤æ–­æ˜¯å¦è°ƒç”¨ï¼›

#### runtime.sysmon

Go ç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šåå°è¿è¡Œä¸€ä¸ªçº¿ç¨‹å®šæ—¶æ‰§è¡Œ runtime.sysmon å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥æ£€æŸ¥æ­»é”ã€è¿è¡Œè®¡æ—¶å™¨ã€è°ƒåº¦æŠ¢å ã€ä»¥åŠ GC ç­‰ã€‚

å®ƒä¼šæ‰§è¡Œ `runtime.gcTrigger`ä¸­çš„ test å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥è¿›è¡Œ GCã€‚ç”±äº GC å¯èƒ½éœ€è¦æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥è¿è¡Œæ—¶ä¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åœ¨åå°å¼€å¯ä¸€ä¸ªç”¨äºå¼ºåˆ¶è§¦å‘åƒåœ¾æ”¶é›†çš„ Goroutine æ‰§è¡Œ forcegchelper å‡½æ•°ã€‚

ä¸è¿‡ forcegchelper å‡½æ•°åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¼šä¸€ç›´è¢« goparkunlock å‡½æ•°ä¸€ç›´æŒ‚èµ·ï¼Œç›´åˆ° sysmon è§¦å‘GC æ ¡éªŒé€šè¿‡ï¼Œæ‰ä¼šå°†è¯¥è¢«æŒ‚èµ·çš„ Goroutine æ”¾è½¬èº«åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œ GCã€‚

#### runtime.GC

è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¼šè·å–å½“å‰çš„ GC å¾ªç¯æ¬¡æ•°ï¼Œç„¶åè®¾å€¼ä¸º gcTriggerCycle æ¨¡å¼è°ƒç”¨ gcStart è¿›è¡Œå¾ªç¯ã€‚

#### runtime.mallocgc

tiny mallocã€small alloc éƒ½ä¼šå…ˆå» mcache ä¸­æ‰¾ç©ºé—²å†…å­˜å—è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœ mcache ä¸­åˆ†é…ä¸åˆ°å†…å­˜ï¼Œå°±è¦åˆ° mcentral æˆ– mheap ä¸­å»ç”³è¯·å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå°è¯•è§¦å‘ GCï¼›è€Œå¯¹äº large alloc ä¸€å®šä¼šå°è¯•è§¦å‘ GC å› ä¸ºå®ƒç›´æ¥åœ¨å †é¡µä¸Šåˆ†é…å†…å­˜ã€‚

### æ§åˆ¶gc

ä¸Šé¢è¿™ä¸‰ä¸ªè§¦å‘ GC çš„åœ°æ–¹æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ gcStart æ‰§è¡Œ GCï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ GC ä¹‹å‰ä¸€å®šä¼šå…ˆåˆ¤æ–­è¿™æ¬¡è°ƒç”¨æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½ä¸€å®šä¼šæ‰§è¡Œ GCï¼Œ è¿™ä¸ªæ—¶å€™å°±è¦è¯´ä¸€ä¸‹ `runtime.gcTrigger`ä¸­çš„ test å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æ ¡éªŒæœ¬æ¬¡ GC æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œã€‚

```go
func (t gcTrigger) test() bool {
	if !memstats.enablegc || panicking.Load() != 0 || gcphase != _GCoff {
		return false
	}
	switch t.kind {
	case gcTriggerHeap:
		trigger, _ := gcController.trigger()
		return gcController.heapLive.Load() >= trigger
	case gcTriggerTime:
		if gcController.gcPercent.Load() < 0 {
			return false
		}
		lastgc := int64(atomic.Load64(&memstats.last_gc_nanotime))
		return lastgc != 0 && t.now-lastgc > forcegcperiod
	case gcTriggerCycle:
		// t.n > work.cycles, but accounting for wraparound.
		return int32(t.n-work.cycles.Load()) > 0
	}
	return true
}
```

- gcTriggerHeapï¼šæŒ‰å †å¤§å°è§¦å‘ï¼Œå †å¤§å°å’Œä¸Šæ¬¡ GC æ—¶ç›¸æ¯”è¾¾åˆ°ä¸€å®šé˜ˆå€¼åˆ™è§¦å‘ï¼›
- gcTriggerTimeï¼šæŒ‰æ—¶é—´è§¦å‘ï¼Œå¦‚æœè¶…è¿‡ forcegcperiodï¼ˆé»˜è®¤2åˆ†é’Ÿï¼‰ æ—¶é—´æ²¡æœ‰è¢« GCï¼Œé‚£ä¹ˆä¼šæ‰§è¡ŒGCï¼›
- gcTriggerCycleï¼šæ²¡æœ‰å¼€å¯åƒåœ¾æ”¶é›†ï¼Œåˆ™è§¦å‘æ–°çš„å¾ªç¯ï¼›

#### Go Memory Ballast

é€šè¿‡è®¾ç½® ballast æ•°ç»„æˆ‘ä»¬è¾¾åˆ°äº†å»¶è¿Ÿ GC çš„æ•ˆæœï¼Œä½†æ˜¯è¿™ç§æ•ˆæœåªä¼šåœ¨ä¸´æ—¶å˜é‡æ¯”è¾ƒå¤šçš„ç³»ç»Ÿä¸­æœ‰ç”¨ï¼Œå¯¹äºå…¨å±€å˜é‡å¤šçš„ç³»ç»Ÿï¼Œç”¨å¤„ä¸å¤§ã€‚

#### Go GC Tuner

åœ¨ Go ä¸­å…¶å®æä¾›äº† `runtime.SetFinalizer` å‡½æ•°ï¼Œå®ƒä¼šåœ¨å¯¹è±¡è¢« GC çš„æ—¶å€™æœ€åå›è°ƒä¸€ä¸‹ã€‚å¯ä»¥é€šè¿‡å®ƒæ¥è®¾ç½®ä¸€ä¸ªé’©å­ï¼Œæ¯æ¬¡ GC å®Œä¹‹åæ£€æŸ¥ä¸€ä¸‹å†…å­˜æƒ…å†µï¼Œç„¶åè®¾ç½® GOGC å€¼ã€‚

#### Soft Memory Limit

Go å®ç°äº†ä¸‰ç§ç­–ç•¥è§¦å‘ GC ï¼Œå…¶ä¸­ä¸€ç§æ˜¯ gcTriggerHeapï¼Œå®ƒä¼šæ ¹æ®å †çš„å¤§å°è®¾å®šä¸‹æ¬¡æ‰§è¡Œ GC çš„å †ç›®æ ‡å€¼ã€‚ 1.19 ç‰ˆçš„ä»£ç æ­£æ˜¯å¯¹ gcTriggerHeap ç­–ç•¥åšäº†ä¿®æ”¹ã€‚

`gcControllerState.heapGoalInternal`è®¡ç®— HeapGoal çš„æ—¶å€™ä½¿ç”¨äº†ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ GOGC å€¼è®¡ç®—ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡ memoryLimit å€¼è®¡ç®—ï¼Œç„¶åå–å®ƒä»¬ä¸¤ä¸ªä¸­å°çš„å€¼ä½œä¸º HeapGoalã€‚

```go
func (c *gcControllerState) heapGoalInternal() (goal, minTrigger uint64) {
	// Start with the goal calculated for gcPercent.
	goal = c.gcPercentHeapGoal.Load()

	// Check if the memory-limit-based goal is smaller, and if so, pick that.
	if newGoal := c.memoryLimitHeapGoal(); newGoal < goal {
		goal = newGoal
	} else {
		// We're not limited by the memory limit goal, so perform a series of
		// adjustments that might move the goal forward in a variety of circumstances.
```

Go GC çš„è§¦å‘æ˜¯å–ä¸Šé¢ä¸¤è€…è®¡ç®—ç»“æœè¾ƒå°çš„å€¼ï¼Œé‚£ä¹ˆåŸæœ¬æˆ‘ä»¬ä½¿ç”¨ GOGC å¡«çš„å¤ªå¤§æ€•å¯¼è‡´ OOMï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åŠ ä¸Š memoryLimit å‚æ•°é™åˆ¶ä¸€ä¸‹ï¼›æˆ–è€…ç›´æ¥ GOGC = off ï¼Œç„¶åè®¾ç½® memoryLimit å‚æ•°ï¼Œé€šè¿‡å®ƒæ¥è°ƒé…æˆ‘ä»¬çš„ GCã€‚
