---
title: "系统架构揭秘--构建安全可靠的系统"
date: 2023-06-14 13:07:00 +8
category: architecture
tag:
  - secure
  - reliable
---

## 第一章 安全性与可靠性的交集

### 设计注意事项

可靠性与安全性的权衡：冗余和事件管理

### 机密性，完整性，可用性

传统定义中，安全系统的基本属性包含机密性（confidentiality），完整性（integrity），可用性（availability），CIA 三要素

可用性，既关乎可用性，有关乎安全性。比较经典的 DDoS（distributed denial-of-service）分布式拒绝服务

### 共性

可靠性和安全性是系统设计中比较突出的属性，并且很难事后再加固，所以设计之初就需要考虑这两个属性，系统变更的过程中，很容易影响这两点，因此需要整个系统生命周期持续关注和测试它们。

#### 隐形

没有紧急情况下，这两者的隐形意味着可以减少和推迟也不会立刻造成严重后果，一旦失效就会带来很严重的后果。

#### 评估

根据所需要的错误预算（sre google 运维揭秘第三章）来计划工程工作，至少一部分是可以这样做的。攻防演练也可以评估。

#### 简洁性

可以帮助提高评估能力，是最佳方法之一。见第 6 章。

#### 演变

随着业务迭代发展，不可避免让系统变得复杂，从而积累技术债务。微小变更导致重大故障。（debian 和 youtube 的案例）

#### 弹性

系统设计应该包含冗余和不同的故障域，从而通过重新路由请求来限制降低故障的影响。第 8 章深入这点。第 10 章深入探讨 DoS 缓解措施。

每个组件的弹性有上限，可以通过纵深防御和故障域来解决。前者是多种防御机制的集合（冗余也是一种），独立故障域是限制故障的爆炸半径。

划分权限和限制凭证的可用范围来实现不同故障域。

最新特权原则可用缓解内部威胁。

google 是使用多方授权来确保敏感操作由特定员工组审批。

#### 从设计到生产

从代码阶段开始，通过代码审阅来发现潜在问题，甚至公共框架和库来防止。第 12 章深入探讨。

实际部署代码的方法也可以控制安全性和可靠性的风险。第 14 章说明。

#### 调查系统和日志

需要制定计划来检测故障并从故障中恢复。

完善的日志记录是检测和防备故障的基础。第 15 章详述日志。日志越完整详细越好，但是也有注意事项，足够大的规模，大量日志带来很大成本，给分析日志带来困难。youtube 的案例说明日志也会带来可靠性的问题，还有安全问题，日志不应该包含认证凭证和个人身份信息等敏感信息。

#### 危机响应

组织响应非常有挑战性，需要提前制定响应计划。

大的组织，需要 24 小时响应或者跨时区协作。安全事件存在矛盾，多方参与和限制信息传递。

危机期间，需要清晰的指挥链和坚实的检查清单，行动手册和协议。

google 已经转化为事件管理（Incident Management at Google，IMAG）来处理危机响应，并且定期使用灾难恢复测试系统（Disaster Recovery Testing program，DiRT）来模拟各种故障来迫使团队应用这些。第 16，17 章说明。

#### 恢复

快速推送变更是把双刃剑，最终归结为风险评估和业务决策。

第 9 章和第 18 章讨论。

#### 小结

安全性和可靠性，最初很容易成为换取更快速度的代价，事后需要高昂的修复成本，所以需要尽早解决。

组织必须了解安全性和可靠性文化，第 21 章，涉及的角色和责任，见第 20 章。

## 第二章 攻击者

### 攻击者的动机

破坏安全性的首要攻击的是人，因此，可用通过攻击者的视角来考虑目的，让我们更好了解采取主动（系统设计时）和被动的（应急响应时）措施。

### 攻击者画像

黑客（hacking）

#### 业务爱好者

技术专家

#### 漏洞研究人员

漏洞奖励计划（vulnerability reward program），也称为漏洞赏金计划（bug bounty program），看 20 章。

#### 黑客活动专家

黑客激进主义（hacktivism）

#### 犯罪分子

通过技术威胁敏感数据而勒索受害者。

也有正常职业工作者处于某些目的而雇佣恶意攻击者。

##### 防御犯罪分子

比如验证码。

#### 自动化和人工智能

未来的一些攻击是可用没有人直接控制下执行的。

第 5 章，自动配置分发和访问证明。

第 14 章，代码自动构建，测试和部署。

第 8 章，DoS 攻击处理。

#### 内部人员

组织的内部人员，内部风险就是这些人构成的威胁。

第 5 章，最小特权技术。

2009-1-31，40min，google 向每个用户每次搜索都显示不详的警告，原因是黑名单 list 被无意添加了"/"，匹配了所有网站。

##### 针对内部风险的设计

检测和降低防范内部风险和恶意外部攻击者的两类风险的策略是类似的

- 最小特权原则（第 5 章）
- 零信任（第 3 章）
- 多方授权（第 5 章）
- 业务缘由（第 5 章）
- 审计和检测（第 15 章）
- 可恢复性（第 9 章）

### 攻击者方法论

比较典型的几个研究攻击者方法的框架：威胁情报，网络杀伤链和 TTP（攻击者如何工作）

#### 威胁情报

对攻击做详细的描述。

- 书面报告
- 失陷指标（indicator of compromise，IOC）是攻击的有限属性集
- 恶意软件报告

#### 网络杀伤链

cyber kill chain，用这种形式化框架来分析攻击。

#### TTP

对攻击者的 TTP 进行系统性的分类。

### 风险评估注意事项

- 你可能没有意识到你是目标
- 攻击的复杂程度并不能真的帮你成功预测攻击
- 不要低估攻击者
- 归因是很难的
- 攻击者并不总是害怕被抓

## 第三章 安全代理

### 生产环境中的安全代理

零接触生产（Zero Touch Production，ZTP）是 google 的一个项目。要求和生产环境的每个更改都必须自动化，非通过人工进行，由软件预先验证，或者经过审查的 Breakglass 机制触发。

## 第四章 设计中的权衡

### 设计目标和要求

#### 特性需求

特性需求，也叫功能需求；关键需求是至关重要的特性需求。

#### 非功能性需求

侧重于系统的通用属性或行为，和安全性和可靠性相关。

#### 功能与涌现特性

可靠性和安全性是系统设计中的涌现特性

#### 案例

google 设计文档模版中可靠性和安全性相关的部分

- 可扩展性
- 冗余和可靠性
- 依赖的注意事项
- 数据的完整性
- SLA 要求
- 安全和隐私考虑

### 需求平衡

**增强现有系统的可靠性和安全性所需的成本**

安全性和可靠性的涌现特性意味着，与之相关的设计通常是最基础的，本质上类似于基础架构体系选型。例如是选用单体架构还是微服务架构。

如果现存系统设计之初没考虑这两点，后期很难加进去。

如果缺乏组件间良好且易于理解的接口定义，同时包含复杂的依赖项，那么它的可用性处于较低的水平，而且容易出现安全问题，即使再多测试和修复也无法改变。

改变现有系统，通常需要很大的时间和成本。而且对于已有系统带来其他缺陷的风险，因此，早期设计系统之初就要考虑安全性和可靠性。

#### 案例

### 处理紧张局势和统一目标

#### 案例

#### 统一涌现特性的需求

### 初始速度和持续速度

结论：团队文化中尽早嵌入安全性和可靠性是很重要的

### 小结

安全性和可靠性是整个开发和运营流程中的主要涌现特性。

安全性，可靠性和功能需求之间有诸多权衡，甚至乍一看是互相冲突的。早期避开前两者似乎很提升了效率，但是带来巨大的成本和风险。

## 第五章 最新特权设计

最小特权设计过程中可能面临权衡和冲突。

人总是会犯错，引用 SRE 的座右铭，“希望不是一种战略”。

### 概念和术语

#### 最小特权

拒绝给工具授予绝对权限，尽可能确保用户没有环境特权，如 root 身份登入权限

#### 零信任网络

设计原则从零信任网络开始，不授予用户所在网络位置的任何访问特权，如内网不能比外网 vpn 获得更多访问权限。系统根据用户凭证和设备凭证的组合授权访问权限。

#### 零接触

自动化构建最小特权概念，目标就是零接触界面。第三章有 ZTP 和 ZTN。

### 基于风险的访问分类

并非所有数据和操作都是对等的，需要根据影响，安全风险和关键程度对访问进行分类。

### 最佳实践

#### API 功能最小化

#### Breakglass 机制

紧急情况下打碎玻璃，在非预期情况下恢复服务。

#### 审计

用于检测不正确的授权。

在Google，执行两大类的审计：

- 审计确保遵循最佳实践的做法
- 审计确认安全违规事件

最佳实践类的审核是为了支持可靠性的目标。SRE团队每周团队会议期间审核上周使用Breakglass机制的事件，形成文化压力，要求使用和改进最小化的服务管理类API，而不是使用Breakglass来作为常规工作。

Google通常会将Breakglass事件的审计下饭到团队级别。

在Google，倾向于第二类审计，因为大组织的多方位视角有益于识别外部的安全漏洞。

在Google，使用结构化论证。将结构化数据与审核日志事件关联起来。例如客户支持人员查看客户的付款详细信息或者其他敏感信息时，可以将这些数据与特定的客户咨询单相关联。这样可以确保观察到的数据属于寻求咨询的客户。

#### 测试和最小特权

合理的测试是任何一个设计精良的系统的基础属性。

最小特权，两个维度：

- **针对**最小特权的测试，确保仅授予必要资源的访问权限
- **使用**最小特权进行测试，确保用于测试的基础设施仅具有所需的访问权限

安全性和可靠性的权衡：测试环境

测试的最佳实践很美好，但是构建适当的测试基础设施的潜在成本很高，但是反过来考虑下没有适当的测试基础设施的成本也很高。所以`投入-产出比`分析很重要。

#### 诊断被拒绝的访问

#### 优雅失败和Breakglass机制

### 工作案例：配置分发

### 认证和授权决策的策略框架

授权控件：有如因素授权MFA，多方授权MPA

随着组织的发展，标准化是必须的。

### 高级控制

#### MPA
